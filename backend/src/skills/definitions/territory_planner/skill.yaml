name: territory-planner
description: Analyzes lead_memories geographic distribution for territory optimization and white-space identification
agent_assignment:
  - strategist
  - analyst
trust_level: core
estimated_seconds: 25

system_prompt: |
  You are ARIA's Territory Planner — a specialized territory intelligence engine for
  life sciences commercial teams. You analyze the geographic distribution of leads,
  accounts, and pipeline to produce territory optimization recommendations.

  Guidelines:
  - Output must be valid JSON matching the output schema exactly.
  - Analyze lead_memories geographic data to identify coverage patterns, gaps, and imbalances.
  - For territory_map output, produce data compatible with insight-visualizer's treemap chart_type
    so the frontend can render a geographic heatmap via Recharts.
  - Monetary values should be numeric (not formatted strings) — the frontend formats display.
  - Health scores and percentages should be 0–100 numeric values.
  - Colors must be valid hex codes from ARIA's palette:
    primary: "#6366F1", success: "#10B981", warning: "#F59E0B",
    danger: "#EF4444", info: "#3B82F6", muted: "#6B7280",
    accent1: "#8B5CF6", accent2: "#EC4899", accent3: "#14B8A6".
  - When data is insufficient for meaningful analysis, return partial results
    with a note in metadata.summary explaining the gap.
  - Include confidence_level based on data completeness:
    high = >80% of territories have 3+ leads,
    moderate = 50–80% have 3+ leads,
    low = <50% have 3+ leads.
  - For white_space_analysis, compare current coverage against known life sciences
    hubs (Boston, San Francisco Bay Area, San Diego, Research Triangle, Philadelphia,
    Minneapolis, New Jersey, Indianapolis, Chicago, Los Angeles, Seattle, Houston,
    Washington DC/Maryland) and flag uncovered markets.
  - For workload_balance, flag territories with >2x the median lead count as overloaded
    and territories with <0.5x the median as underserved.
  - For travel_optimization, cluster leads by geographic proximity and suggest
    efficient visit sequences that minimize travel between accounts.

output_schema:
  type: object
  required:
    - analysis_type
    - territories
    - recommendations
    - metadata
  properties:
    analysis_type:
      type: string
      enum:
        - territory_map
        - white_space_analysis
        - workload_balance
        - travel_optimization
      description: Type of territory analysis performed
    territories:
      type: array
      items:
        type: object
        required:
          - name
          - lead_count
          - pipeline_value
        properties:
          name:
            type: string
            description: Territory or region name
          lead_count:
            type: integer
            description: Number of leads in this territory
          pipeline_value:
            type: number
            description: Total pipeline value (numeric USD)
          avg_health_score:
            type: number
            description: Average health score 0–100
          avg_deal_size:
            type: number
            description: Average deal size in USD
          top_accounts:
            type: array
            items:
              type: string
            description: Names of top accounts in territory
          status:
            type: string
            enum:
              - overloaded
              - balanced
              - underserved
              - uncovered
            description: Workload balance status
      description: Territory data points
    visualization:
      type: object
      description: Insight-visualizer compatible chart spec for heatmap rendering
      properties:
        chart_type:
          type: string
          enum:
            - treemap
        data:
          type: array
          items:
            type: object
          description: Recharts-compatible data array with name, size, count, health keys
        config:
          type: object
          properties:
            title:
              type: string
            subtitle:
              type: string
            xKey:
              type: string
            yKeys:
              type: array
              items:
                type: object
                properties:
                  key:
                    type: string
                  label:
                    type: string
                  color:
                    type: string
    recommendations:
      type: array
      items:
        type: object
        required:
          - action
          - rationale
          - priority
        properties:
          action:
            type: string
            description: Recommended action
          rationale:
            type: string
            description: Data-driven justification
          priority:
            type: string
            enum:
              - high
              - medium
              - low
          impact_estimate:
            type: string
            description: Expected impact if action is taken
          affected_territories:
            type: array
            items:
              type: string
            description: Territory names affected by this recommendation
      description: Actionable recommendations based on analysis
    metadata:
      type: object
      properties:
        template:
          type: string
          description: Template used to generate this analysis
        generated_at:
          type: string
          description: ISO 8601 timestamp
        data_sources:
          type: array
          items:
            type: string
          description: Tables and memory types queried
        record_count:
          type: integer
          description: Number of lead records analyzed
        territory_count:
          type: integer
          description: Number of distinct territories identified
        confidence_level:
          type: string
          enum:
            - high
            - moderate
            - low
          description: Confidence based on data completeness
        summary:
          type: string
          description: One-line natural language summary of the analysis

input_requirements:
  - template_name
  - user_id

templates:
  territory_map:
    description: "Geographic heatmap of lead distribution with pipeline value sizing for {user_id}"
  white_space_analysis:
    description: "Identify uncovered life sciences markets and expansion opportunities for {user_id}"
  workload_balance:
    description: "Analyze rep workload across territories and flag imbalances for {user_id}"
  travel_optimization:
    description: "Cluster leads by proximity and suggest efficient visit routes for {user_id}"
