name: compliance-guardian
description: Detects PHI/PII and flags Sunshine Act reporting requirements for life sciences compliance
agent_assignment:
  - scribe
  - operator
  - analyst
trust_level: core
estimated_seconds: 15

system_prompt: |
  You are ARIA's Compliance Guardian — a specialized compliance engine for
  life sciences commercial teams. You combine pattern-based detection with
  contextual analysis to identify Protected Health Information (PHI),
  Personally Identifiable Information (PII), and potential Sunshine Act
  (Open Payments) reporting obligations.

  Guidelines:
  - Output must be valid JSON matching the output schema exactly.
  - For compliance_review: analyze the provided text for all categories of
    sensitive data. Pattern matches alone are not sufficient — consider context.
    A name near medical information is PHI even without an explicit patient ID.
  - For redaction_report: return the original text with all PHI/PII replaced
    by [REDACTED] tokens, plus a manifest of what was redacted and why.
  - PHI categories to detect:
    - Direct identifiers: SSN, MRN (Medical Record Number), patient IDs
    - Quasi-identifiers: DOB, ZIP code + age + gender combinations
    - Clinical data near identifiers: drug names + patient names co-occurrence,
      diagnosis + name, treatment + name
    - Contextual PII: names appearing near medical terms, health conditions,
      or treatment information
  - PII categories to detect:
    - SSN (XXX-XX-XXXX pattern)
    - Phone numbers, email addresses
    - Full names when paired with sensitive context
  - Sunshine Act triggers:
    - Meals/entertainment provided to HCPs (Healthcare Professionals)
    - Speaking fees, consulting arrangements with HCPs
    - Travel and lodging for HCPs
    - Research grants or educational contributions
    - Gifts or samples above de minimis thresholds
    - Any transfer of value to a physician or teaching hospital
  - Confidence mapping:
    - Pattern match (SSN, MRN format): 0.95
    - Name + medical context co-occurrence: 0.85
    - Ambiguous references: 0.60
    - Inferred from surrounding context: 0.50
  - When in doubt, flag for human review rather than ignoring.
  - NEVER include the actual sensitive data in your analysis — refer to it
    by type and location only.

output_schema:
  type: object
  required:
    - review_type
    - findings
    - risk_level
    - metadata
  properties:
    review_type:
      type: string
      enum:
        - compliance_review
        - redaction_report
      description: Type of compliance analysis performed
    findings:
      type: array
      items:
        type: object
        required:
          - category
          - description
          - confidence
          - action_required
        properties:
          category:
            type: string
            enum:
              - phi_direct_identifier
              - phi_quasi_identifier
              - phi_clinical_context
              - pii_ssn
              - pii_contact
              - pii_contextual
              - sunshine_act_meal
              - sunshine_act_speaking
              - sunshine_act_consulting
              - sunshine_act_travel
              - sunshine_act_research
              - sunshine_act_gift
              - sunshine_act_general
            description: Category of the compliance finding
          description:
            type: string
            description: What was found and why it matters (never include actual sensitive data)
          confidence:
            type: number
            description: Detection confidence 0.0–1.0
          location:
            type: string
            description: Approximate location in text (e.g. "paragraph 2, line 3")
          action_required:
            type: string
            enum:
              - redact
              - report
              - review
              - flag
            description: Required compliance action
          regulation:
            type: string
            description: Applicable regulation (HIPAA, Sunshine Act, GDPR, etc.)
      description: List of compliance findings
    redacted_text:
      type: string
      description: Text with PHI/PII replaced by [REDACTED] tokens (redaction_report only)
    sunshine_act_summary:
      type: object
      description: Summary of potential Sunshine Act reporting obligations
      properties:
        requires_reporting:
          type: boolean
        total_transfers_of_value:
          type: integer
          description: Number of distinct transfers of value identified
        hcp_names_referenced:
          type: integer
          description: Number of HCP names found in context
        estimated_total_value:
          type: string
          description: Estimated aggregate value if determinable
        reporting_deadline_note:
          type: string
          description: Reminder about reporting deadlines
    risk_level:
      type: string
      enum:
        - critical
        - high
        - medium
        - low
      description: Overall compliance risk assessment
    metadata:
      type: object
      properties:
        template:
          type: string
          description: Template used for this analysis
        generated_at:
          type: string
          description: ISO 8601 timestamp
        data_sources:
          type: array
          items:
            type: string
          description: Data sources analyzed
        patterns_checked:
          type: integer
          description: Number of regex patterns evaluated
        confidence_level:
          type: string
          enum:
            - high
            - moderate
            - low
          description: Overall confidence in the review completeness
        summary:
          type: string
          description: One-line natural language summary

input_requirements:
  - template_name
  - text_content

templates:
  compliance_review:
    description: "Full compliance scan of text for PHI/PII and Sunshine Act triggers"
  redaction_report:
    description: "Redact PHI/PII from text and produce a manifest of changes"
